<!DOCTYPE HTML>
<html>
<head><meta name="generator" content="Hexo 3.9.0">
  <!-- hexo-inject:begin --><!-- hexo-inject:end --><meta charset="utf-8">
  
  <title>WebBench源码分析 | winterfell30</title>
  <meta name="author" content="Winterfell30">
  
  <meta name="description" content="Always Challenge Miracle">
  
  
  <meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1">

  <meta property="og:title" content="WebBench源码分析">
  <meta property="og:site_name" content="winterfell30">

  
    <meta property="og:image" content="undefined">
  

  <link href="/favicon.png" rel="icon">
  <link rel="alternate" href="/atom.xml" title="winterfell30" type="application/atom+xml">
  <link rel="stylesheet" href="/css/style.css" media="screen" type="text/css">
  <!--[if lt IE 9]><script src="//html5shiv.googlecode.com/svn/trunk/html5.js"></script><![endif]--><!-- hexo-inject:begin --><!-- hexo-inject:end -->
  

</head>
</html>

<body>
  <!-- hexo-inject:begin --><!-- hexo-inject:end --><header id="header" class="inner"><div class="alignleft">
  <h1><a href="/">winterfell30</a></h1>
  <h2><a href="/"></a></h2>
</div>
<nav id="main-nav" class="alignright">
  <ul>
    
      <li><a href="/">Home</a></li>
    
      <li><a href="/archives">Archives</a></li>
    
      <li><a href="/about/index.html">About</a></li>
    
  </ul>
  <div class="clearfix"></div>
</nav>
<div class="clearfix"></div>
</header>
  <div id="content" class="inner">
    <div id="main-col" class="alignleft"><div id="wrapper"><article class="post">
  
  <div class="post-content">
    <header>
      
        <div class="icon"></div>
        <time datetime="2017-04-11T05:25:44.000Z"><a href="/2017/04/11/webbench-source/">2017-04-11</a></time>
      
      
  
    <h1 class="title">WebBench源码分析</h1>
  

    </header>
    <div class="entry">
      
        <p>RT<br><a id="more"></a><br>之前测试HTTP服务器性能的时候用到这个，好奇是怎么实现的就去看了一下源码，源码很短只有五百多行，思路和想象中差不多比较简单。<br><a href="https://github.com/EZLippi/WebBench" target="_blank" rel="noopener">源码地址：https://github.com/EZLippi/WebBench</a><br>大体流程就是：<br><img src="http://7xno52.com1.z0.glb.clouddn.com/webbenchsource.png" alt></p>
<p>源码有两个c文件，主要函数：<br><figure class="highlight reasonml"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="built_in">int</span> <span class="constructor">Socket(<span class="params">const</span> <span class="params">char</span> <span class="operator">*</span><span class="params">host</span>, <span class="params">int</span> <span class="params">clientPort</span>)</span>;</span><br></pre></td></tr></table></figure></p>
<p>接受主机和端口，创建连接，返回套接字的描述符，返回-1连接失败。</p>
<figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">static</span> <span class="keyword">void</span> <span class="title">build_request</span><span class="params">(<span class="keyword">const</span> <span class="keyword">char</span> *url)</span></span>;</span><br></pre></td></tr></table></figure>
<p>接受url，创建http请求报文头</p>
<figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">static</span> <span class="keyword">int</span> <span class="title">bench</span><span class="params">(<span class="keyword">void</span>)</span></span>;</span><br></pre></td></tr></table></figure>
<p>创建管道，创建子进程，判断进程是子进程还是父进程。<br>如果是子进程调用benchcore创建连接结果写进管道，如果是父进程读取管道结果统计一下输出出来</p>
<figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">static</span> <span class="keyword">void</span> <span class="title">benchcore</span><span class="params">(<span class="keyword">const</span> <span class="keyword">char</span>* host,<span class="keyword">const</span> <span class="keyword">int</span> port, <span class="keyword">const</span> <span class="keyword">char</span> *request)</span></span>;</span><br></pre></td></tr></table></figure>
<p>创建HTTP连接测试，对HTTP请求进行测试。</p>
<p>整体思路比较清晰，一些细节的处理比较多。</p>
<p>源代码及注释：<br><figure class="highlight arduino"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">int</span> <span class="title">Socket</span><span class="params">(<span class="keyword">const</span> <span class="keyword">char</span> *host, <span class="keyword">int</span> clientPort)</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">    <span class="keyword">int</span> sock;</span><br><span class="line">    <span class="keyword">unsigned</span> <span class="keyword">long</span> inaddr;</span><br><span class="line">    <span class="class"><span class="keyword">struct</span> <span class="title">sockaddr_in</span> <span class="title">ad</span>;</span></span><br><span class="line">    <span class="class"><span class="keyword">struct</span> <span class="title">hostent</span> *<span class="title">hp</span>;</span></span><br><span class="line">    </span><br><span class="line">    <span class="built_in">memset</span>(&amp;ad, <span class="number">0</span>, <span class="keyword">sizeof</span>(ad));                    <span class="comment">//初始化地址</span></span><br><span class="line">    ad.sin_family = AF_INET;</span><br><span class="line"></span><br><span class="line">    inaddr = inet_addr(host);                      <span class="comment">//点分十进制的IP转换成一个长整数型数      </span></span><br><span class="line">    <span class="keyword">if</span> (inaddr != INADDR_NONE)                     <span class="comment">//如果是IP</span></span><br><span class="line">        <span class="built_in">memcpy</span>(&amp;ad.sin_addr, &amp;inaddr, <span class="keyword">sizeof</span>(inaddr));</span><br><span class="line">    <span class="keyword">else</span>                                           <span class="comment">//如果是域名先获取IP</span></span><br><span class="line">    &#123;</span><br><span class="line">        hp = gethostbyname(host);</span><br><span class="line">        <span class="keyword">if</span> (hp == <span class="literal">NULL</span>)</span><br><span class="line">            <span class="keyword">return</span> <span class="number">-1</span>;</span><br><span class="line">        <span class="built_in">memcpy</span>(&amp;ad.sin_addr, hp-&gt;h_addr, hp-&gt;h_length);</span><br><span class="line">    &#125;</span><br><span class="line">    ad.sin_port = htons(clientPort);               <span class="comment">//将16位数从主机字节顺序转换成网络字节顺序</span></span><br><span class="line">    </span><br><span class="line">    sock = socket(AF_INET, SOCK_STREAM, <span class="number">0</span>);        <span class="comment">//创建套接字</span></span><br><span class="line">    <span class="keyword">if</span> (sock &lt; <span class="number">0</span>)</span><br><span class="line">        <span class="keyword">return</span> sock;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">if</span> (<span class="built_in">connect</span>(sock, (struct sockaddr *)&amp;ad, <span class="keyword">sizeof</span>(ad)) &lt; <span class="number">0</span>)   <span class="comment">//创建连接</span></span><br><span class="line">        <span class="keyword">return</span> <span class="number">-1</span>;</span><br><span class="line">    <span class="keyword">return</span> sock;                                   <span class="comment">//返回套接字描述符</span></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></p>
<figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">volatile</span> <span class="keyword">int</span> timerexpired=<span class="number">0</span>;                                          </span><br><span class="line"><span class="keyword">int</span> speed=<span class="number">0</span>;</span><br><span class="line"><span class="keyword">int</span> failed=<span class="number">0</span>;</span><br><span class="line"><span class="keyword">int</span> bytes=<span class="number">0</span>;</span><br><span class="line"></span><br><span class="line"><span class="comment">/* globals */</span></span><br><span class="line"><span class="keyword">int</span> http10=<span class="number">1</span>; <span class="comment">/* 0 - http/0.9, 1 - http/1.0, 2 - http/1.1 */</span></span><br><span class="line"></span><br><span class="line"><span class="comment">/* Allow: GET, HEAD, OPTIONS, TRACE */</span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">define</span> METHOD_GET 0</span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">define</span> METHOD_HEAD 1</span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">define</span> METHOD_OPTIONS 2</span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">define</span> METHOD_TRACE 3</span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">define</span> PROGRAM_VERSION <span class="meta-string">"1.5"</span></span></span><br><span class="line"></span><br><span class="line"><span class="keyword">int</span> method=METHOD_GET;             <span class="comment">//默认GET</span></span><br><span class="line"><span class="keyword">int</span> clients=<span class="number">1</span>;                     <span class="comment">//默认只有1个客户端</span></span><br><span class="line"><span class="keyword">int</span> force=<span class="number">0</span>;                       <span class="comment">//默认等待服务器请求</span></span><br><span class="line"><span class="keyword">int</span> force_reload=<span class="number">0</span>;                <span class="comment">//默认失败时不重新相应</span></span><br><span class="line"><span class="keyword">int</span> proxyport=<span class="number">80</span>;             </span><br><span class="line"><span class="keyword">char</span> *proxyhost=<span class="literal">NULL</span>;              <span class="comment">//默认不使用代理</span></span><br><span class="line"><span class="keyword">int</span> benchtime=<span class="number">30</span>;                  <span class="comment">//默认测试时间</span></span><br><span class="line"></span><br><span class="line"><span class="comment">/* internal */</span></span><br><span class="line"><span class="keyword">int</span> mypipe[<span class="number">2</span>];</span><br><span class="line"><span class="keyword">char</span> host[MAXHOSTNAMELEN];</span><br><span class="line"><span class="meta">#<span class="meta-keyword">define</span> REQUEST_SIZE 2048</span></span><br><span class="line"><span class="keyword">char</span> request[REQUEST_SIZE];</span><br><span class="line"></span><br><span class="line"><span class="keyword">static</span> <span class="keyword">const</span> <span class="class"><span class="keyword">struct</span> <span class="title">option</span> <span class="title">long_options</span>[]=</span></span><br><span class="line"><span class="class">&#123;</span></span><br><span class="line">    &#123;<span class="string">"force"</span>,no_argument,&amp;force,<span class="number">1</span>&#125;,</span><br><span class="line">    &#123;<span class="string">"reload"</span>,no_argument,&amp;force_reload,<span class="number">1</span>&#125;,</span><br><span class="line">    &#123;<span class="string">"time"</span>,required_argument,<span class="literal">NULL</span>,<span class="string">'t'</span>&#125;,</span><br><span class="line">    &#123;<span class="string">"help"</span>,no_argument,<span class="literal">NULL</span>,<span class="string">'?'</span>&#125;,</span><br><span class="line">    &#123;<span class="string">"http09"</span>,no_argument,<span class="literal">NULL</span>,<span class="string">'9'</span>&#125;,</span><br><span class="line">    &#123;<span class="string">"http10"</span>,no_argument,<span class="literal">NULL</span>,<span class="string">'1'</span>&#125;,</span><br><span class="line">    &#123;<span class="string">"http11"</span>,no_argument,<span class="literal">NULL</span>,<span class="string">'2'</span>&#125;,</span><br><span class="line">    &#123;<span class="string">"get"</span>,no_argument,&amp;method,METHOD_GET&#125;,</span><br><span class="line">    &#123;<span class="string">"head"</span>,no_argument,&amp;method,METHOD_HEAD&#125;,</span><br><span class="line">    &#123;<span class="string">"options"</span>,no_argument,&amp;method,METHOD_OPTIONS&#125;,</span><br><span class="line">    &#123;<span class="string">"trace"</span>,no_argument,&amp;method,METHOD_TRACE&#125;,</span><br><span class="line">    &#123;<span class="string">"version"</span>,no_argument,<span class="literal">NULL</span>,<span class="string">'V'</span>&#125;,</span><br><span class="line">    &#123;<span class="string">"proxy"</span>,required_argument,<span class="literal">NULL</span>,<span class="string">'p'</span>&#125;,</span><br><span class="line">    &#123;<span class="string">"clients"</span>,required_argument,<span class="literal">NULL</span>,<span class="string">'c'</span>&#125;,</span><br><span class="line">    &#123;<span class="literal">NULL</span>,<span class="number">0</span>,<span class="literal">NULL</span>,<span class="number">0</span>&#125;</span><br><span class="line">&#125;;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">static</span> <span class="keyword">void</span> <span class="title">alarm_handler</span><span class="params">(<span class="keyword">int</span> signal)</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">    timerexpired=<span class="number">1</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">//help信息</span></span><br><span class="line"><span class="function"><span class="keyword">static</span> <span class="keyword">void</span> <span class="title">usage</span><span class="params">(<span class="keyword">void</span>)</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">    <span class="built_in">fprintf</span>(<span class="built_in">stderr</span>,</span><br><span class="line">            <span class="string">"webbench [option]... URL\n"</span></span><br><span class="line">            <span class="string">"  -f|--force               Don't wait for reply from server.\n"</span></span><br><span class="line">            <span class="string">"  -r|--reload              Send reload request - Pragma: no-cache.\n"</span></span><br><span class="line">            <span class="string">"  -t|--time &lt;sec&gt;          Run benchmark for &lt;sec&gt; seconds. Default 30.\n"</span></span><br><span class="line">            <span class="string">"  -p|--proxy &lt;server:port&gt; Use proxy server for request.\n"</span></span><br><span class="line">            <span class="string">"  -c|--clients &lt;n&gt;         Run &lt;n&gt; HTTP clients at once. Default one.\n"</span></span><br><span class="line">            <span class="string">"  -9|--http09              Use HTTP/0.9 style requests.\n"</span></span><br><span class="line">            <span class="string">"  -1|--http10              Use HTTP/1.0 protocol.\n"</span></span><br><span class="line">            <span class="string">"  -2|--http11              Use HTTP/1.1 protocol.\n"</span></span><br><span class="line">            <span class="string">"  --get                    Use GET request method.\n"</span></span><br><span class="line">            <span class="string">"  --head                   Use HEAD request method.\n"</span></span><br><span class="line">            <span class="string">"  --options                Use OPTIONS request method.\n"</span></span><br><span class="line">            <span class="string">"  --trace                  Use TRACE request method.\n"</span></span><br><span class="line">            <span class="string">"  -?|-h|--help             This information.\n"</span></span><br><span class="line">            <span class="string">"  -V|--version             Display program version.\n"</span></span><br><span class="line">           );</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">int</span> <span class="title">main</span><span class="params">(<span class="keyword">int</span> argc, <span class="keyword">char</span> *argv[])</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">    <span class="keyword">int</span> opt=<span class="number">0</span>;</span><br><span class="line">    <span class="keyword">int</span> options_index=<span class="number">0</span>;</span><br><span class="line">    <span class="keyword">char</span> *tmp=<span class="literal">NULL</span>;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">if</span>(argc==<span class="number">1</span>)                 <span class="comment">//没有参数</span></span><br><span class="line">    &#123;</span><br><span class="line">        usage();</span><br><span class="line">        <span class="keyword">return</span> <span class="number">2</span>;</span><br><span class="line">    &#125; </span><br><span class="line"></span><br><span class="line">    <span class="comment">//使用getopt_long处理命令行，linux下可使用man 3 getlong_opt查看使用方法</span></span><br><span class="line">    <span class="keyword">while</span>((opt=getopt_long(argc,argv,<span class="string">"912Vfrt:p:c:?h"</span>,long_options,&amp;options_index))!=EOF )</span><br><span class="line">    &#123;</span><br><span class="line">        <span class="keyword">switch</span>(opt)</span><br><span class="line">        &#123;</span><br><span class="line">            <span class="keyword">case</span>  <span class="number">0</span> : <span class="keyword">break</span>;</span><br><span class="line">            <span class="keyword">case</span> <span class="string">'f'</span>: force=<span class="number">1</span>;<span class="keyword">break</span>;</span><br><span class="line">            <span class="keyword">case</span> <span class="string">'r'</span>: force_reload=<span class="number">1</span>;<span class="keyword">break</span>; </span><br><span class="line">            <span class="keyword">case</span> <span class="string">'9'</span>: http10=<span class="number">0</span>;<span class="keyword">break</span>;</span><br><span class="line">            <span class="keyword">case</span> <span class="string">'1'</span>: http10=<span class="number">1</span>;<span class="keyword">break</span>;</span><br><span class="line">            <span class="keyword">case</span> <span class="string">'2'</span>: http10=<span class="number">2</span>;<span class="keyword">break</span>;</span><br><span class="line">            <span class="keyword">case</span> <span class="string">'V'</span>: <span class="built_in">printf</span>(PROGRAM_VERSION<span class="string">"\n"</span>);<span class="built_in">exit</span>(<span class="number">0</span>);</span><br><span class="line">            <span class="keyword">case</span> <span class="string">'t'</span>: benchtime=atoi(optarg);<span class="keyword">break</span>;	     </span><br><span class="line">            <span class="keyword">case</span> <span class="string">'p'</span>: </span><br><span class="line">            <span class="comment">/* proxy server parsing server:port */</span></span><br><span class="line">            tmp=<span class="built_in">strrchr</span>(optarg,<span class="string">':'</span>);</span><br><span class="line">            proxyhost=optarg;</span><br><span class="line">            <span class="keyword">if</span>(tmp==<span class="literal">NULL</span>)</span><br><span class="line">            &#123;</span><br><span class="line">                <span class="keyword">break</span>;</span><br><span class="line">            &#125;</span><br><span class="line">            <span class="keyword">if</span>(tmp==optarg)</span><br><span class="line">            &#123;</span><br><span class="line">                <span class="built_in">fprintf</span>(<span class="built_in">stderr</span>,<span class="string">"Error in option --proxy %s: Missing hostname.\n"</span>,optarg);</span><br><span class="line">                <span class="keyword">return</span> <span class="number">2</span>;</span><br><span class="line">            &#125;</span><br><span class="line">            <span class="keyword">if</span>(tmp==optarg+<span class="built_in">strlen</span>(optarg)<span class="number">-1</span>)</span><br><span class="line">            &#123;</span><br><span class="line">                <span class="built_in">fprintf</span>(<span class="built_in">stderr</span>,<span class="string">"Error in option --proxy %s Port number is missing.\n"</span>,optarg);</span><br><span class="line">                <span class="keyword">return</span> <span class="number">2</span>;</span><br><span class="line">            &#125;</span><br><span class="line">            *tmp=<span class="string">'\0'</span>;</span><br><span class="line">            proxyport=atoi(tmp+<span class="number">1</span>);<span class="keyword">break</span>;</span><br><span class="line">            <span class="keyword">case</span> <span class="string">':'</span>:</span><br><span class="line">            <span class="keyword">case</span> <span class="string">'h'</span>:</span><br><span class="line">            <span class="keyword">case</span> <span class="string">'?'</span>: usage();<span class="keyword">return</span> <span class="number">2</span>;<span class="keyword">break</span>;</span><br><span class="line">            <span class="keyword">case</span> <span class="string">'c'</span>: clients=atoi(optarg);<span class="keyword">break</span>;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">if</span>(optind==argc) &#123;</span><br><span class="line">        <span class="built_in">fprintf</span>(<span class="built_in">stderr</span>,<span class="string">"webbench: Missing URL!\n"</span>);</span><br><span class="line">        usage();</span><br><span class="line">        <span class="keyword">return</span> <span class="number">2</span>;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">if</span>(clients==<span class="number">0</span>) clients=<span class="number">1</span>;</span><br><span class="line">    <span class="keyword">if</span>(benchtime==<span class="number">0</span>) benchtime=<span class="number">30</span>;</span><br><span class="line"> </span><br><span class="line">    <span class="comment">/* Copyright */</span></span><br><span class="line">    <span class="built_in">fprintf</span>(<span class="built_in">stderr</span>,<span class="string">"Webbench - Simple Web Benchmark "</span>PROGRAM_VERSION<span class="string">"\n"</span></span><br><span class="line">            <span class="string">"Copyright (c) Radim Kolar 1997-2004, GPL Open Source Software.\n"</span></span><br><span class="line">            );</span><br><span class="line"> </span><br><span class="line">    build_request(argv[optind]);</span><br><span class="line"></span><br><span class="line">    <span class="built_in">printf</span>(<span class="string">"Runing info: "</span>);</span><br><span class="line"></span><br><span class="line">    <span class="keyword">if</span>(clients==<span class="number">1</span>) </span><br><span class="line">        <span class="built_in">printf</span>(<span class="string">"1 client"</span>);</span><br><span class="line">    <span class="keyword">else</span></span><br><span class="line">        <span class="built_in">printf</span>(<span class="string">"%d clients"</span>,clients);</span><br><span class="line"></span><br><span class="line">    <span class="built_in">printf</span>(<span class="string">", running %d sec"</span>, benchtime);</span><br><span class="line">    </span><br><span class="line">    <span class="keyword">if</span>(force) <span class="built_in">printf</span>(<span class="string">", early socket close"</span>);</span><br><span class="line">    <span class="keyword">if</span>(proxyhost!=<span class="literal">NULL</span>) <span class="built_in">printf</span>(<span class="string">", via proxy server %s:%d"</span>,proxyhost,proxyport);</span><br><span class="line">    <span class="keyword">if</span>(force_reload) <span class="built_in">printf</span>(<span class="string">", forcing reload"</span>);</span><br><span class="line">    </span><br><span class="line">    <span class="built_in">printf</span>(<span class="string">".\n"</span>);</span><br><span class="line">    </span><br><span class="line">    <span class="keyword">return</span> bench();</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">void</span> <span class="title">build_request</span><span class="params">(<span class="keyword">const</span> <span class="keyword">char</span> *url)</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">    <span class="keyword">char</span> tmp[<span class="number">10</span>];</span><br><span class="line">    <span class="keyword">int</span> i;</span><br><span class="line"></span><br><span class="line">    <span class="comment">//bzero(host,MAXHOSTNAMELEN);</span></span><br><span class="line">    <span class="comment">//bzero(request,REQUEST_SIZE);</span></span><br><span class="line">    <span class="built_in">memset</span>(host,<span class="number">0</span>,MAXHOSTNAMELEN);</span><br><span class="line">    <span class="built_in">memset</span>(request,<span class="number">0</span>,REQUEST_SIZE);</span><br><span class="line"></span><br><span class="line">    <span class="keyword">if</span>(force_reload &amp;&amp; proxyhost!=<span class="literal">NULL</span> &amp;&amp; http10&lt;<span class="number">1</span>) http10=<span class="number">1</span>;           <span class="comment">//使用了缓存和代理，HTTP/0.9不行</span></span><br><span class="line">    <span class="keyword">if</span>(method==METHOD_HEAD &amp;&amp; http10&lt;<span class="number">1</span>) http10=<span class="number">1</span>;</span><br><span class="line">    <span class="keyword">if</span>(method==METHOD_OPTIONS &amp;&amp; http10&lt;<span class="number">2</span>) http10=<span class="number">2</span>;</span><br><span class="line">    <span class="keyword">if</span>(method==METHOD_TRACE &amp;&amp; http10&lt;<span class="number">2</span>) http10=<span class="number">2</span>;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">switch</span>(method)</span><br><span class="line">    &#123;</span><br><span class="line">        <span class="keyword">default</span>:</span><br><span class="line">        <span class="keyword">case</span> METHOD_GET: <span class="built_in">strcpy</span>(request,<span class="string">"GET"</span>);<span class="keyword">break</span>;</span><br><span class="line">        <span class="keyword">case</span> METHOD_HEAD: <span class="built_in">strcpy</span>(request,<span class="string">"HEAD"</span>);<span class="keyword">break</span>;</span><br><span class="line">        <span class="keyword">case</span> METHOD_OPTIONS: <span class="built_in">strcpy</span>(request,<span class="string">"OPTIONS"</span>);<span class="keyword">break</span>;</span><br><span class="line">        <span class="keyword">case</span> METHOD_TRACE: <span class="built_in">strcpy</span>(request,<span class="string">"TRACE"</span>);<span class="keyword">break</span>;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="built_in">strcat</span>(request,<span class="string">" "</span>);</span><br><span class="line"></span><br><span class="line">    <span class="keyword">if</span>(<span class="literal">NULL</span>==<span class="built_in">strstr</span>(url,<span class="string">"://"</span>))                                         <span class="comment">//查找://是否存在</span></span><br><span class="line">    &#123;</span><br><span class="line">        <span class="built_in">fprintf</span>(<span class="built_in">stderr</span>, <span class="string">"\n%s: is not a valid URL.\n"</span>,url);</span><br><span class="line">        <span class="built_in">exit</span>(<span class="number">2</span>);</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">if</span>(<span class="built_in">strlen</span>(url)&gt;<span class="number">1500</span>)                                                <span class="comment">//链接长度小于1500</span></span><br><span class="line">    &#123;</span><br><span class="line">        <span class="built_in">fprintf</span>(<span class="built_in">stderr</span>,<span class="string">"URL is too long.\n"</span>);</span><br><span class="line">        <span class="built_in">exit</span>(<span class="number">2</span>);</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">if</span> (<span class="number">0</span>!=strncasecmp(<span class="string">"http://"</span>,url,<span class="number">7</span>))                                <span class="comment">//只支持HTTP地址</span></span><br><span class="line">    &#123; </span><br><span class="line">        <span class="built_in">fprintf</span>(<span class="built_in">stderr</span>,<span class="string">"\nOnly HTTP protocol is directly supported, set --proxy for others.\n"</span>);</span><br><span class="line">        <span class="built_in">exit</span>(<span class="number">2</span>);</span><br><span class="line">    &#125;</span><br><span class="line">    </span><br><span class="line">    <span class="comment">/* protocol/host delimiter */</span></span><br><span class="line">    i=<span class="built_in">strstr</span>(url,<span class="string">"://"</span>)-url+<span class="number">3</span>;                                          <span class="comment">//找到://之后的地址（主机名地址）</span></span><br><span class="line"></span><br><span class="line">    <span class="keyword">if</span>(<span class="built_in">strchr</span>(url+i,<span class="string">'/'</span>)==<span class="literal">NULL</span>) &#123;          </span><br><span class="line">        <span class="built_in">fprintf</span>(<span class="built_in">stderr</span>,<span class="string">"\nInvalid URL syntax - hostname don't ends with '/'.\n"</span>);</span><br><span class="line">        <span class="built_in">exit</span>(<span class="number">2</span>);</span><br><span class="line">    &#125;</span><br><span class="line">    </span><br><span class="line">    <span class="keyword">if</span>(proxyhost==<span class="literal">NULL</span>)</span><br><span class="line">    &#123;</span><br><span class="line">        <span class="comment">/* get port from hostname */</span></span><br><span class="line">        <span class="keyword">if</span>(index(url+i,<span class="string">':'</span>)!=<span class="literal">NULL</span> &amp;&amp; index(url+i,<span class="string">':'</span>)&lt;index(url+i,<span class="string">'/'</span>))</span><br><span class="line">        &#123;</span><br><span class="line">            <span class="built_in">strncpy</span>(host,url+i,<span class="built_in">strchr</span>(url+i,<span class="string">':'</span>)-url-i);                <span class="comment">//取出主机地址</span></span><br><span class="line">            <span class="built_in">memset</span>(tmp,<span class="number">0</span>,<span class="number">10</span>);</span><br><span class="line">            <span class="built_in">strncpy</span>(tmp,index(url+i,<span class="string">':'</span>)+<span class="number">1</span>,<span class="built_in">strchr</span>(url+i,<span class="string">'/'</span>)-index(url+i,<span class="string">':'</span>)<span class="number">-1</span>);</span><br><span class="line">            proxyport=atoi(tmp);                                        <span class="comment">//端口   </span></span><br><span class="line">            <span class="keyword">if</span>(proxyport==<span class="number">0</span>) proxyport=<span class="number">80</span>;</span><br><span class="line">        &#125; </span><br><span class="line">        <span class="keyword">else</span></span><br><span class="line">        &#123;</span><br><span class="line">            <span class="built_in">strncpy</span>(host,url+i,<span class="built_in">strcspn</span>(url+i,<span class="string">"/"</span>));</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="comment">// printf("Host=%s\n",host);</span></span><br><span class="line">        <span class="built_in">strcat</span>(request+<span class="built_in">strlen</span>(request),url+i+<span class="built_in">strcspn</span>(url+i,<span class="string">"/"</span>));</span><br><span class="line">    &#125; </span><br><span class="line">    <span class="keyword">else</span></span><br><span class="line">    &#123;</span><br><span class="line">        <span class="comment">// printf("ProxyHost=%s\nProxyPort=%d\n",proxyhost,proxyport);</span></span><br><span class="line">        <span class="built_in">strcat</span>(request,url);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">if</span>(http10==<span class="number">1</span>)</span><br><span class="line">        <span class="built_in">strcat</span>(request,<span class="string">" HTTP/1.0"</span>);</span><br><span class="line">    <span class="keyword">else</span> <span class="keyword">if</span> (http10==<span class="number">2</span>)</span><br><span class="line">        <span class="built_in">strcat</span>(request,<span class="string">" HTTP/1.1"</span>);</span><br><span class="line">  </span><br><span class="line">    <span class="built_in">strcat</span>(request,<span class="string">"\r\n"</span>);</span><br><span class="line">  </span><br><span class="line">    <span class="keyword">if</span>(http10&gt;<span class="number">0</span>)</span><br><span class="line">        <span class="built_in">strcat</span>(request,<span class="string">"User-Agent: WebBench "</span>PROGRAM_VERSION<span class="string">"\r\n"</span>);</span><br><span class="line">    <span class="keyword">if</span>(proxyhost==<span class="literal">NULL</span> &amp;&amp; http10&gt;<span class="number">0</span>)</span><br><span class="line">    &#123;</span><br><span class="line">        <span class="built_in">strcat</span>(request,<span class="string">"Host: "</span>);</span><br><span class="line">        <span class="built_in">strcat</span>(request,host);</span><br><span class="line">        <span class="built_in">strcat</span>(request,<span class="string">"\r\n"</span>);</span><br><span class="line">    &#125;</span><br><span class="line"> </span><br><span class="line">    <span class="keyword">if</span>(force_reload &amp;&amp; proxyhost!=<span class="literal">NULL</span>)</span><br><span class="line">    &#123;</span><br><span class="line">        <span class="built_in">strcat</span>(request,<span class="string">"Pragma: no-cache\r\n"</span>);</span><br><span class="line">    &#125;</span><br><span class="line">  </span><br><span class="line">    <span class="keyword">if</span>(http10&gt;<span class="number">1</span>)</span><br><span class="line">        <span class="built_in">strcat</span>(request,<span class="string">"Connection: close\r\n"</span>);</span><br><span class="line">    </span><br><span class="line">    <span class="comment">/* add empty line at end */</span></span><br><span class="line">    <span class="keyword">if</span>(http10&gt;<span class="number">0</span>) <span class="built_in">strcat</span>(request,<span class="string">"\r\n"</span>); </span><br><span class="line">    </span><br><span class="line">    <span class="built_in">printf</span>(<span class="string">"\nRequest:\n%s\n"</span>,request);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<figure class="highlight arduino"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">/*这一段自带注释比较多*/</span></span><br><span class="line"><span class="function"><span class="keyword">static</span> <span class="keyword">int</span> <span class="title">bench</span><span class="params">(<span class="keyword">void</span>)</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">    <span class="keyword">int</span> i,j,k;	</span><br><span class="line">    <span class="keyword">pid_t</span> pid=<span class="number">0</span>;</span><br><span class="line">    FILE *f;</span><br><span class="line"></span><br><span class="line">    <span class="comment">/* check avaibility of target server */</span></span><br><span class="line">    i=Socket(proxyhost==<span class="literal">NULL</span>?host:proxyhost,proxyport);</span><br><span class="line">    <span class="keyword">if</span>(i&lt;<span class="number">0</span>) &#123; </span><br><span class="line">        <span class="built_in">fprintf</span>(<span class="built_in">stderr</span>,<span class="string">"\nConnect to server failed. Aborting benchmark.\n"</span>);</span><br><span class="line">        <span class="keyword">return</span> <span class="number">1</span>;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="built_in">close</span>(i);</span><br><span class="line">    </span><br><span class="line">    <span class="comment">/* create pipe */</span></span><br><span class="line">    <span class="keyword">if</span>(pipe(mypipe))</span><br><span class="line">    &#123;</span><br><span class="line">        perror(<span class="string">"pipe failed."</span>);</span><br><span class="line">        <span class="keyword">return</span> <span class="number">3</span>;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">/* fork childs */</span></span><br><span class="line">    <span class="comment">//make childs faster的意思不是让子进程更快，是产生子进程更快</span></span><br><span class="line">    <span class="comment">//判断pid发现不是父进程就sleep把CPU让给父进程产生更多的子进程，make childs faster</span></span><br><span class="line">    <span class="keyword">for</span>(i=<span class="number">0</span>;i&lt;clients;i++)</span><br><span class="line">    &#123;</span><br><span class="line">        pid=fork();</span><br><span class="line">        <span class="keyword">if</span>(pid &lt;= (<span class="keyword">pid_t</span>) <span class="number">0</span>)</span><br><span class="line">        &#123;</span><br><span class="line">            <span class="comment">/* child process or error*/</span></span><br><span class="line">            sleep(<span class="number">1</span>); <span class="comment">/* make childs faster */</span></span><br><span class="line">            <span class="keyword">break</span>;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">if</span>( pid &lt; (<span class="keyword">pid_t</span>) <span class="number">0</span>)</span><br><span class="line">    &#123;</span><br><span class="line">        <span class="built_in">fprintf</span>(<span class="built_in">stderr</span>,<span class="string">"problems forking worker no. %d\n"</span>,i);</span><br><span class="line">        perror(<span class="string">"fork failed."</span>);</span><br><span class="line">        <span class="keyword">return</span> <span class="number">3</span>;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">if</span>(pid == (<span class="keyword">pid_t</span>) <span class="number">0</span>)</span><br><span class="line">    &#123;</span><br><span class="line">        <span class="comment">/* I am a child */</span></span><br><span class="line">        <span class="keyword">if</span>(proxyhost==<span class="literal">NULL</span>)</span><br><span class="line">            benchcore(host,proxyport,request);</span><br><span class="line">        <span class="keyword">else</span></span><br><span class="line">            benchcore(proxyhost,proxyport,request);</span><br><span class="line"></span><br><span class="line">        <span class="comment">/* write results to pipe */</span></span><br><span class="line">        f=fdopen(mypipe[<span class="number">1</span>],<span class="string">"w"</span>);</span><br><span class="line">        <span class="keyword">if</span>(f==<span class="literal">NULL</span>)</span><br><span class="line">        &#123;</span><br><span class="line">            perror(<span class="string">"open pipe for writing failed."</span>);</span><br><span class="line">            <span class="keyword">return</span> <span class="number">3</span>;</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="comment">/* fprintf(stderr,"Child - %d %d\n",speed,failed); */</span></span><br><span class="line">        <span class="built_in">fprintf</span>(f,<span class="string">"%d %d %d\n"</span>,speed,failed,bytes);</span><br><span class="line">        fclose(f);</span><br><span class="line"></span><br><span class="line">        <span class="keyword">return</span> <span class="number">0</span>;</span><br><span class="line">    &#125; </span><br><span class="line">    <span class="keyword">else</span></span><br><span class="line">    &#123;</span><br><span class="line">        f=fdopen(mypipe[<span class="number">0</span>],<span class="string">"r"</span>);</span><br><span class="line">        <span class="keyword">if</span>(f==<span class="literal">NULL</span>) </span><br><span class="line">        &#123;</span><br><span class="line">            perror(<span class="string">"open pipe for reading failed."</span>);</span><br><span class="line">            <span class="keyword">return</span> <span class="number">3</span>;</span><br><span class="line">        &#125;</span><br><span class="line">        </span><br><span class="line">        setvbuf(f,<span class="literal">NULL</span>,_IONBF,<span class="number">0</span>);</span><br><span class="line">        </span><br><span class="line">        speed=<span class="number">0</span>;</span><br><span class="line">        failed=<span class="number">0</span>;</span><br><span class="line">        bytes=<span class="number">0</span>;</span><br><span class="line">    </span><br><span class="line">        <span class="keyword">while</span>(<span class="number">1</span>)</span><br><span class="line">        &#123;</span><br><span class="line">            pid=<span class="built_in">fscanf</span>(f,<span class="string">"%d %d %d"</span>,&amp;i,&amp;j,&amp;k);</span><br><span class="line">            <span class="keyword">if</span>(pid&lt;<span class="number">2</span>)</span><br><span class="line">            &#123;</span><br><span class="line">                <span class="built_in">fprintf</span>(<span class="built_in">stderr</span>,<span class="string">"Some of our childrens died.\n"</span>);</span><br><span class="line">                <span class="keyword">break</span>;</span><br><span class="line">            &#125;</span><br><span class="line">            </span><br><span class="line">            speed+=i;</span><br><span class="line">            failed+=j;</span><br><span class="line">            bytes+=k;</span><br><span class="line">        </span><br><span class="line">            <span class="comment">/* fprintf(stderr,"*Knock* %d %d read=%d\n",speed,failed,pid); */</span></span><br><span class="line">            <span class="keyword">if</span>(--clients==<span class="number">0</span>) <span class="keyword">break</span>;</span><br><span class="line">        &#125;</span><br><span class="line">    </span><br><span class="line">        fclose(f);</span><br><span class="line"></span><br><span class="line">        <span class="comment">//输出测试结果</span></span><br><span class="line">        <span class="built_in">printf</span>(<span class="string">"\nSpeed=%d pages/min, %d bytes/sec.\nRequests: %d susceed, %d failed.\n"</span>,</span><br><span class="line">            (<span class="keyword">int</span>)((speed+failed)/(benchtime/<span class="number">60.0f</span>)),</span><br><span class="line">            (<span class="keyword">int</span>)(bytes/(<span class="keyword">float</span>)benchtime),</span><br><span class="line">            speed,</span><br><span class="line">            failed);</span><br><span class="line">    &#125;</span><br><span class="line">    </span><br><span class="line">    <span class="keyword">return</span> i;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<figure class="highlight arduino"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">void</span> <span class="title">benchcore</span><span class="params">(<span class="keyword">const</span> <span class="keyword">char</span> *host,<span class="keyword">const</span> <span class="keyword">int</span> port,<span class="keyword">const</span> <span class="keyword">char</span> *req)</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">    <span class="keyword">int</span> rlen;</span><br><span class="line">    <span class="keyword">char</span> buf[<span class="number">1500</span>];</span><br><span class="line">    <span class="keyword">int</span> s,i;</span><br><span class="line">    <span class="class"><span class="keyword">struct</span> <span class="title">sigaction</span> <span class="title">sa</span>;</span></span><br><span class="line"></span><br><span class="line">    <span class="comment">/* setup alarm signal handler */</span></span><br><span class="line">    sa.sa_handler=alarm_handler;                   <span class="comment">//定时器方法</span></span><br><span class="line">    sa.sa_flags=<span class="number">0</span>;</span><br><span class="line">    <span class="keyword">if</span>(sigaction(SIGALRM,&amp;sa,<span class="literal">NULL</span>))</span><br><span class="line">        <span class="built_in">exit</span>(<span class="number">3</span>);</span><br><span class="line">    </span><br><span class="line">    alarm(benchtime); <span class="comment">// after benchtime,then exit</span></span><br><span class="line"></span><br><span class="line">    rlen=<span class="built_in">strlen</span>(req);</span><br><span class="line">    nexttry:<span class="keyword">while</span>(<span class="number">1</span>)</span><br><span class="line">    &#123;</span><br><span class="line">        <span class="keyword">if</span>(timerexpired)                           <span class="comment">//定时器到的时候就会退出循环</span></span><br><span class="line">        &#123;</span><br><span class="line">            <span class="keyword">if</span>(failed&gt;<span class="number">0</span>)</span><br><span class="line">            &#123;</span><br><span class="line">                <span class="comment">/* fprintf(stderr,"Correcting failed by signal\n"); */</span></span><br><span class="line">                failed--;</span><br><span class="line">            &#125;</span><br><span class="line">            <span class="keyword">return</span>;</span><br><span class="line">        &#125;</span><br><span class="line">        </span><br><span class="line">        s=Socket(host,port);                          </span><br><span class="line">        <span class="keyword">if</span>(s&lt;<span class="number">0</span>) &#123; failed++;<span class="keyword">continue</span>;&#125; </span><br><span class="line">        <span class="keyword">if</span>(rlen!=<span class="built_in">write</span>(s,req,rlen)) &#123;failed++;<span class="built_in">close</span>(s);<span class="keyword">continue</span>;&#125;</span><br><span class="line">        <span class="keyword">if</span>(http10==<span class="number">0</span>) <span class="keyword">if</span>(<span class="built_in">shutdown</span>(s,<span class="number">1</span>)) &#123; failed++;<span class="built_in">close</span>(s);<span class="keyword">continue</span>;&#125;</span><br><span class="line">        <span class="keyword">if</span>(force==<span class="number">0</span>) </span><br><span class="line">        &#123;</span><br><span class="line">            <span class="comment">/* read all available data from socket */</span></span><br><span class="line">            <span class="keyword">while</span>(<span class="number">1</span>)</span><br><span class="line">            &#123;</span><br><span class="line">                <span class="keyword">if</span>(timerexpired) <span class="keyword">break</span>; </span><br><span class="line">                i=<span class="built_in">read</span>(s,buf,<span class="number">1500</span>);</span><br><span class="line">                <span class="comment">/* fprintf(stderr,"%d\n",i); */</span></span><br><span class="line">                <span class="keyword">if</span>(i&lt;<span class="number">0</span>) </span><br><span class="line">                &#123; </span><br><span class="line">                    failed++;</span><br><span class="line">                    <span class="built_in">close</span>(s);</span><br><span class="line">                    <span class="keyword">goto</span> nexttry;</span><br><span class="line">                &#125;</span><br><span class="line">                <span class="keyword">else</span></span><br><span class="line">                <span class="keyword">if</span>(i==<span class="number">0</span>) <span class="keyword">break</span>;</span><br><span class="line">                <span class="keyword">else</span> bytes+=i;</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">if</span>(<span class="built_in">close</span>(s)) &#123;failed++;<span class="keyword">continue</span>;&#125;</span><br><span class="line">        speed++;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

      
    </div>
    <footer>
      
        
        
  
  <div class="tags">
    <a href="/tags/网络/">网络</a>, <a href="/tags/Linux/">Linux</a>
  </div>

        
      
      <div class="clearfix"></div>
    </footer>
  </div>
</article>


<section id="comment">
  <h1 class="title">留言</h1>

  
  <div id="disqus_thread">
    <noscript>Please enable JavaScript to view the <a href="//disqus.com/?ref_noscript">comments powered by Disqus.</a></noscript>
  </div>
  
</section>

</div></div>
    <aside id="sidebar" class="alignright">
  

<SCRIPT language=javascript>
function search(formname) {
    formname.method = "get";
    formname.action = "http://www.google.com/google";
    document.search_form.word.value = document.search_form.word.value + " site:wintefell30";
    return true;
}
</SCRIPT>

<div class="search">
    <form name="search_form" target="_blank" onsubmit="search(this)">
        <input type="search" name="word" results="0" placeholder="搜索" onblur="this.value=''">
        <!-- <input type="submit" value="搜索"> -->
    </form>
</div>

  <iframe frameborder="no" border="0" marginwidth="0" marginheight="0" width=280 height=450 src="//music.163.com/outchain/player?type=0&id=118612228&auto=0&height=430"></iframe>

  

  
<div class="widget tag">
  <h3 class="title">标签</h3>
  <ul class="entry">
  
    <li><a href="/tags/C/">C++</a><small>11</small></li>
  
    <li><a href="/tags/Haskell/">Haskell</a><small>1</small></li>
  
    <li><a href="/tags/Linux/">Linux</a><small>2</small></li>
  
    <li><a href="/tags/Python/">Python</a><small>2</small></li>
  
    <li><a href="/tags/备忘/">备忘</a><small>1</small></li>
  
    <li><a href="/tags/杂记/">杂记</a><small>3</small></li>
  
    <li><a href="/tags/模板/">模板</a><small>1</small></li>
  
    <li><a href="/tags/系统/">系统</a><small>2</small></li>
  
    <li><a href="/tags/网络/">网络</a><small>4</small></li>
  
    <li><a href="/tags/资料/">资料</a><small>3</small></li>
  
    <li><a href="/tags/题解/">题解</a><small>6</small></li>
  
  </ul>
</div>


  
  <div class="widget tag">
    <h3 class="title">友情链接</h3>
    <ul class="entry">
        
          <li>
            <a href="http://blog.bipedalbit.net/">Bipedalbit</a>
          </li>
        
          <li>
            <a href="http://ibrother.me">iBrother</a>
          </li>
        
          <li>
            <a href="http://midgar.moe/">Midgar</a>
          </li>
        
          <li>
            <a href="http://arcphase20.com/">phase</a>
          </li>
        
          <li>
            <a href="http://mycodebattle.com">PureFrog</a>
          </li>
        
          <li>
            <a href="http://www.cnblogs.com/qscqesze/">qscqesze</a>
          </li>
        
          <li>
            <a href="http://scalpel.vip/">Scalpel</a>
          </li>
        
          <li>
            <a href="http://www.sevenskey.xyz/365/index.html">Sevenskey</a>
          </li>
        
          <li>
            <a href="http://shield-sky.github.io/">Shield-sky</a>
          </li>
        
          <li>
            <a href="http://syhdaily.com/">Syhsyh9696</a>
          </li>
        
          <li>
            <a href="http://vvwall.com/">vvwall</a>
          </li>
        
    </div>
  </div>


</aside>
    <div class="clearfix"></div>
  </div>
  <footer id="footer" class="inner"><div class="alignleft">
  
  &copy; 2020 Winterfell30
  
</div>
<div class="clearfix"></div></footer>
  <script src="//ajax.googleapis.com/ajax/libs/jquery/2.0.3/jquery.min.js"></script>
<script src="/js/jquery.imagesloaded.min.js"></script>
<script src="/js/gallery.js"></script>


<script type="text/javascript">
var disqus_shortname = 'winterfell30';

(function(){
  var dsq = document.createElement('script');
  dsq.type = 'text/javascript';
  dsq.async = true;
  dsq.src = '//' + disqus_shortname + '.disqus.com/embed.js';
  (document.getElementsByTagName('head')[0] || document.getElementsByTagName('body')[0]).appendChild(dsq);
}());
</script>



<link rel="stylesheet" href="/fancybox/jquery.fancybox.css" media="screen" type="text/css">
<script src="/fancybox/jquery.fancybox.pack.js"></script>
<script type="text/javascript">
(function($){
  $('.fancybox').fancybox();
})(jQuery);
</script><!-- hexo-inject:begin --><!-- Begin: Injected MathJax -->
<script type="text/x-mathjax-config">
  MathJax.Hub.Config({"tex2jax":{"inlineMath":[["$","$"],["\\(","\\)"]],"skipTags":["script","noscript","style","textarea","pre","code"],"processEscapes":true},"TeX":{"equationNumbers":{"autoNumber":"AMS"}}});
</script>

<script type="text/x-mathjax-config">
  MathJax.Hub.Queue(function() {
    var all = MathJax.Hub.getAllJax(), i;
    for(i=0; i < all.length; i += 1) {
      all[i].SourceElement().parentNode.className += ' has-jax';
    }
  });
</script>

<script type="text/javascript" src="https://cdnjs.cloudflare.com/ajax/libs/mathjax/2.7.1/MathJax.js">
</script>
<!-- End: Injected MathJax -->
<!-- hexo-inject:end -->

</body>
</html>
